# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to NEW server for a PR
"on": pull_request
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    environment: development
    steps:
      - uses: actions/checkout@v2
      - name: Decrypt large secret
        run: ./.github/scripts/decrypt.sh
        env:
          PASS: ${{ secrets.PASS }}
      - name: Find and Replace
        env:
          MONGO_URL: ${{ secrets.MONGO_URL_DEV }}
          ACCOUNTS_BASE_URL: ${{ secrets.ACCOUNTS_BASE_URL_DEV }}
          NODE_ENV: ${{ secrets.NODE_ENV_DEV }}
          SMTP_URL: ${{ secrets.SMTP_URL_DEV }}
          AUTH_BASE_URL: ${{ secrets.AUTH_BASE_URL_DEV }}
          KNAWAT_MP_BASE_URL: ${{ secrets.KNAWAT_MP_BASE_URL_DEV }}
          BASIC_USER: ${{ secrets.BASIC_USER_DEV }}
          BASIC_PASS: ${{ secrets.BASIC_PASS_DEV }}
          GTM_ID: ${{ secrets.GTM_ID_DEV }}
        run: sed -i -e "s/__MONGO_URL__/$MONGO_URL/g" deploy/settings.json \
             sed -i -e "s/__ACCOUNTS_BASE_URL__/$ACCOUNTS_BASE_URL/g" deploy/settings.json \
             sed -i -e "s/__NODE_ENV__/$NODE_ENV/g" deploy/settings.json \
             sed -i -e "s/__SMTP_URL__/$SMTP_URL/g" deploy/settings.json \
             sed -i -e "s/__AUTH_BASE_URL__/$AUTH_BASE_URL/g" deploy/settings.json \
             sed -i -e "s/__KNAWAT_MP_BASE_URL__/$KNAWAT_MP_BASE_URL/g" deploy/settings.json \
             sed -i -e "s/__BASIC_USER__/$BASIC_USER/g" deploy/settings.json \
             sed -i -e "s/__BASIC_PASS__/$BASIC_PASS/g" deploy/settings.json \
             sed -i -e "s/__GTM_ID__/$GTM_ID/g" deploy/settings.json
      - uses: meteorengineer/setup-meteor@v1
        with:
          meteor-release: "1.8.1"
      - name: Meteor Deploy
        env:
          PR_NAME: ${{  }}
        run: METEOR_SESSION_FILE=$HOME/secrets/token.json meteor deploy $PR_NAME.meteorapp.com --owner knawat --settings ./settings.json